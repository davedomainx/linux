# Allow http/s  zone=public is default
firewall-cmd --permanent --zone=public --add-service=http
firewall-cmd --permanent --zone=public --add-service=https
firewall-cmd --permanent --zone=public --list-services

# Allow NFS:
firewall-cmd --permanent --add-service=nfs
firewall-cmd --permanent --add-service=mountd
firewall-cmd --permanent --add-service=rpc-bind
firewall-cmd --permanent --add-service=ftp

# Allow foreman-ports
firewall-cmd --permanent --add-port 8443/tcp # foreman-proxy
firewall-cmd --permanent --add-port 8140/tcp # puppet
firewall-cmd --permanent --add-port 5910-5930/tcp # server VNC consoles

# firewall-cmd --list-ports # 5910-5930 were missing ..
firewall-cmd --reload  ## to fix missing 5910-5930 ports

foreman-installer \
  --enable-foreman-proxy \
  --enable-foreman-compute-libvirt

puppet agent --test

## hammer
# turn off annoying hammer warning output (Silences all)
echo export RUBYOPT=\"-W0\" >> /etc/profile

hammer domain list # davedomain set from foreman-installer ..

hammer subnet create --boot-mode Static --description "Foreman static network for naming" --domain-ids 1 --mask 255.255.255.0 --name Foreman_Static --network 192.168.11.0

# see other file for 7.4 centos directory-from-ISO setup
 hammer medium create --name "CentOS 7.4 1708 local" --operatingsystem-ids 1 --os-family Redhat --path nfs://daveserver.davedomain:/data/iso/CentOS-7-x86-64-1708

 # create hostgroup for good organisation
 # subnet-id 1 = foreman-Static subnet I setup earlier
 # operatingsystem-id 1 = Centos 7.4 I setup earlier
 # medium-id 9 = centos 7.4 1708 local that I setup above
 # architecture-id = x86-64

hammer hostgroup create --name "Naming Servers" --subnet-id 1 --architecture-id 1 --medium-id 9 --domain davedomain

hammer hostgroup update --name "Naming Servers" --operatingsystem-id 1
hammer hostgroup update --name "Naming Servers" --description "Naming Servers (DNS/DHCP)"
hammer hostgroup update --name "Naming Servers" --environment production --puppet-proxy daveserver.davedomain --puppet-ca-proxy daveserver.davedomain

# associate partition table for the Centos 7.4 to Kickstart default
hammer os add-ptable --id 1  --partition-table "Kickstart default"

# Create libvirt compute resource
# FIXME this didnt actually work, had to create it via web-gui ..
hammer compute-resource create --name libvirtd --provider Libvirt --url qemu+ssh://root@daveserver.davedomain/system

# setup ssh for the 'foreman' user account to connect to libvirtd
# foreman 1.17 manual, s.5.2.5, libvirtd stuff
chmod 700 /usr/share/foreman/.ssh
chown foreman:foreman /usr/share/foreman/.ssh

su foreman -s /bin/bash
foreman$ ssh-keygen
foreman$ ssh-copy-id root@daveserver.davedomain
foreman$ ssh root@daveserver.davedomain
exit

augtool -s set /files/etc/libvirt/libvirtd.conf/listen_tls 0
augtool -s set /files/etc/libvirt/libvirtd.conf/listen_tcp 1
augtool -s set /files/etc/libvirt/libvirtd.conf/auth_tcp "none"

/etc/sysconfig/libvirtd:
LIBVIRTD_ARGS="--listen" # un-comment this out

# after the libvirtd restart I can connect to the libvirtd in foreman
systemctl restart libvirtd

## setup libvirt virtual network for naming services
/etc/libvirt/qemu/networks/foreman_static.xml:
<network>
  <name>foreman_static</name>
  <uuid>aad69fe1-b740-40a6-b6cc-3d6c1dcaebf2</uuid>
  <forward mode='nat'/>
  <bridge name='virbr1' stp='on' delay='0'/>
  <mac address='52:54:00:20:1f:50'/>
  <ip address='192.168.11.1' netmask='255.255.255.0'>
  </ip>
</network>

virsh net-define /etc/libvirt/qemu/networks/foreman_static.xml
virsh net-create /etc/libvirt/qemu/networks/foreman_static.xml
virsh net-autostart foreman_static ## creates symlink
virsh net-list ## confirm persistent and autostarts

# libvirt has native support for ZFS, setup a storage pool 1st ..
zfs create data/vmpool
zfs set quota=100G data/vmpool
zfs list

# Support is in libvirt for ZFS, but it's not defaulted
# need to rebuild the libvirt RPM
https://plone.lucidsolutions.co.nz/linux/libvirt/enable-zfs-storage-driver-with-centos-v7-libvirt-v2.0.0-storage-driver

yum -y groupinstall "Development Tools"
yum -y install rpm-build
## rpmbuild requires bunch of dependencies ..
yum -y install libxml2-devel readline-devel ncurses-devel libtasn1-devel gnutls-devel libattr-devel libblkid-devel systemd-devel libpciaccess-devel yajl-devel sanlock-devel libpcap-devel libnl3-devel avahi-devel libselinux-devel cyrus-sasl-devel polkit-devel libacl-devel parted-devel device-mapper-devel librados2-devel librbd1-devel glusterfs-api-devel glusterfs-devel numactl-devel libcap-ng-devel fuse-devel netcf-devel libcurl-devel audit-libs-devel systemtap-sdt-devel dbus-devel scrub

rpm -Uvh https://buildlogs.centos.org/c7.1804.00.x86_64/libvirt/201804122
14704/3.9.0-14.el7.x86_64/libvirt-3.9.0-14.el7.src.rpm
cd rpmbuild/SPECS
rpmbuild -ba --rebuild libvirt.spec
# Seems specfile had a wrong assumption about zfs binary locations
# fix with:
sed -i 's@/sbin/zpool@/usr/sbin/zpool@g' libvirt.spec
sed -i 's@/sbin/zfs@/usr/sbin/zfs@g' libvirt.spec
rpmbuild -ba --rebuild libvirt.spec

# also needed further fixes in libvirt.spec for:
# F25+ has zfs-fuse
%if 0%{?fedora} >= 25
    %define with_storage_zfs      0%{!?_without_storage_zfs:1}
## comment out this bit here
## something keeps turning off zfs build options ....
#%else
#    %define with_storage_zfs      0
%endif

cd /root/RPMS/x86_64
yum reinstall *

systemctl daemon-reload
systemctl restart libvirtd

which libvirtd
/usr/sbin/libvirtd
libvirtd --version
libvirtd (libvirt) 3.9.0
systemctl start libvirtd   # okay
systemctl status libvirtd  # okay

# --source-name data = the zpool name is
# this creates data/zfsvmpool zvol
virsh pool-define-as --name zfsvmpool --source-name data --type zfs
virsh pool-list --all
virsh pool-autostart zfsvmpool
virsh pool-start zfsvmpool
virsh vol-create-as --pool zfsvmpool --name vol1 --capacity 20G


# setup 1st machine namer99 in forman webGUI, webconsole problem
# see if machine is running in libvirt ..
su - foreman -s /bin/bash
# -bash-4.2$ virsh -c qemu+ssh://root@daveserver.davedomain/system list
# Id    Name                           State
# ----------------------------------------------------
# 1     namer99.davedomain             running
